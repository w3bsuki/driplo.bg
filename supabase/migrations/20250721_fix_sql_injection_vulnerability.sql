-- Fix SQL injection vulnerability in order cancellation
-- Create a safe function to increment listing quantity

CREATE OR REPLACE FUNCTION increment_listing_quantity(
    listing_id UUID,
    quantity_increment INTEGER
)
RETURNS VOID AS $$
BEGIN
    -- Validate inputs
    IF quantity_increment < 0 THEN
        RAISE EXCEPTION 'Quantity increment must be non-negative';
    END IF;
    
    -- Safely update the listing quantity
    UPDATE listings
    SET 
        available_quantity = available_quantity + quantity_increment,
        updated_at = NOW()
    WHERE id = listing_id;
    
    -- Check if update was successful
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Listing not found: %', listing_id;
    END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION increment_listing_quantity TO authenticated;

-- Add comment for documentation
COMMENT ON FUNCTION increment_listing_quantity IS 'Safely increments the available quantity of a listing. Used during order cancellation to restore inventory.';